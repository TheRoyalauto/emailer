{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/swizz/Desktop/Emailer/emailer/src/app/api/scrape-leads/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\n// Use Google Gemini Flash\r\nconst genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY || \"\");\r\n\r\ninterface ScrapedContact {\r\n    email: string;\r\n    name?: string;\r\n    company?: string;\r\n    phone?: string;\r\n    location?: string;\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const { prompt } = await request.json();\r\n\r\n        if (!prompt) {\r\n            return NextResponse.json(\r\n                { error: \"Prompt is required\" },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        if (!process.env.GOOGLE_AI_API_KEY) {\r\n            return NextResponse.json(\r\n                { error: \"Google AI API key not configured\" },\r\n                { status: 500 }\r\n            );\r\n        }\r\n\r\n        const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash\" });\r\n\r\n        const systemPrompt = `You are a lead generation assistant. Given a user's request, generate a list of realistic business contacts that match their criteria.\r\n\r\nFor each contact, provide:\r\n- email (required): A realistic business email\r\n- name: Full name of the contact person\r\n- company: Company/business name\r\n- phone: Phone number with area code\r\n- location: City, State\r\n\r\nGenerate contacts that would realistically exist based on the user's query. Make emails realistic (using common business domain patterns like @gmail.com, @yahoo.com, or company domains).\r\n\r\nIMPORTANT: Return ONLY a valid JSON array of contacts. No explanation, no markdown, just the JSON array.\r\n\r\nExample output:\r\n[\r\n  {\"email\": \"john.smith@autobodyshop.com\", \"name\": \"John Smith\", \"company\": \"Smith's Auto Body\", \"phone\": \"555-123-4567\", \"location\": \"Los Angeles, CA\"},\r\n  {\"email\": \"sarah@collisionrepair.net\", \"name\": \"Sarah Johnson\", \"company\": \"Johnson Collision Center\", \"phone\": \"555-234-5678\", \"location\": \"Los Angeles, CA\"}\r\n]`;\r\n\r\n        // Retry logic for rate limits\r\n        let result;\r\n        let lastError;\r\n        for (let attempt = 0; attempt < 3; attempt++) {\r\n            try {\r\n                result = await model.generateContent([\r\n                    { text: systemPrompt },\r\n                    { text: `User request: ${prompt}` }\r\n                ]);\r\n                break;\r\n            } catch (err) {\r\n                lastError = err;\r\n                if (err instanceof Error && err.message.includes(\"429\")) {\r\n                    // Wait before retry (exponential backoff)\r\n                    await new Promise(resolve => setTimeout(resolve, (attempt + 1) * 2000));\r\n                    continue;\r\n                }\r\n                throw err;\r\n            }\r\n        }\r\n\r\n        if (!result) {\r\n            throw lastError || new Error(\"Failed after retries\");\r\n        }\r\n\r\n        const responseText = result.response.text() || \"[]\";\r\n\r\n        // Parse the JSON response\r\n        let contacts: ScrapedContact[] = [];\r\n        try {\r\n            // Try to extract JSON from the response\r\n            const jsonMatch = responseText.match(/\\[[\\s\\S]*\\]/);\r\n            if (jsonMatch) {\r\n                contacts = JSON.parse(jsonMatch[0]);\r\n            }\r\n        } catch {\r\n            console.error(\"Failed to parse AI response:\", responseText);\r\n            return NextResponse.json(\r\n                { error: \"Failed to parse AI response\" },\r\n                { status: 500 }\r\n            );\r\n        }\r\n\r\n        // Validate and clean contacts\r\n        const validContacts = contacts\r\n            .filter(c => c.email && c.email.includes(\"@\"))\r\n            .map(c => ({\r\n                email: c.email.toLowerCase().trim(),\r\n                name: c.name?.trim(),\r\n                company: c.company?.trim(),\r\n                phone: c.phone?.trim(),\r\n                location: c.location?.trim(),\r\n            }));\r\n\r\n        return NextResponse.json({\r\n            contacts: validContacts,\r\n            count: validContacts.length,\r\n        });\r\n    } catch (error) {\r\n        console.error(\"Scrape leads error:\", error);\r\n        const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\r\n        return NextResponse.json(\r\n            { error: `Failed to generate leads: ${errorMessage}` },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;AAAA;AACA;;;AAEA,0BAA0B;AAC1B,MAAM,QAAQ,IAAI,gKAAA,CAAA,qBAAkB,CAAC,QAAQ,GAAG,CAAC,iBAAiB,IAAI;AAU/D,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,MAAM,EAAE,MAAM,EAAE,GAAG,MAAM,QAAQ,IAAI;QAErC,IAAI,CAAC,QAAQ;YACT,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAEtB;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAE;YAChC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAmC,GAC5C;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YAAE,OAAO;QAAmB;QAEnE,MAAM,eAAe,CAAC;;;;;;;;;;;;;;;;;CAiB7B,CAAC;QAEM,8BAA8B;QAC9B,IAAI;QACJ,IAAI;QACJ,IAAK,IAAI,UAAU,GAAG,UAAU,GAAG,UAAW;YAC1C,IAAI;gBACA,SAAS,MAAM,MAAM,eAAe,CAAC;oBACjC;wBAAE,MAAM;oBAAa;oBACrB;wBAAE,MAAM,CAAC,cAAc,EAAE,QAAQ;oBAAC;iBACrC;gBACD;YACJ,EAAE,OAAO,KAAK;gBACV,YAAY;gBACZ,IAAI,eAAe,SAAS,IAAI,OAAO,CAAC,QAAQ,CAAC,QAAQ;oBACrD,0CAA0C;oBAC1C,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,CAAC,UAAU,CAAC,IAAI;oBACjE;gBACJ;gBACA,MAAM;YACV;QACJ;QAEA,IAAI,CAAC,QAAQ;YACT,MAAM,aAAa,IAAI,MAAM;QACjC;QAEA,MAAM,eAAe,OAAO,QAAQ,CAAC,IAAI,MAAM;QAE/C,0BAA0B;QAC1B,IAAI,WAA6B,EAAE;QACnC,IAAI;YACA,wCAAwC;YACxC,MAAM,YAAY,aAAa,KAAK,CAAC;YACrC,IAAI,WAAW;gBACX,WAAW,KAAK,KAAK,CAAC,SAAS,CAAC,EAAE;YACtC;QACJ,EAAE,OAAM;YACJ,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAEtB;QAEA,8BAA8B;QAC9B,MAAM,gBAAgB,SACjB,MAAM,CAAC,CAAA,IAAK,EAAE,KAAK,IAAI,EAAE,KAAK,CAAC,QAAQ,CAAC,MACxC,GAAG,CAAC,CAAA,IAAK,CAAC;gBACP,OAAO,EAAE,KAAK,CAAC,WAAW,GAAG,IAAI;gBACjC,MAAM,EAAE,IAAI,EAAE;gBACd,SAAS,EAAE,OAAO,EAAE;gBACpB,OAAO,EAAE,KAAK,EAAE;gBAChB,UAAU,EAAE,QAAQ,EAAE;YAC1B,CAAC;QAEL,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YACrB,UAAU;YACV,OAAO,cAAc,MAAM;QAC/B;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uBAAuB;QACrC,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC9D,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACpB;YAAE,OAAO,CAAC,0BAA0B,EAAE,cAAc;QAAC,GACrD;YAAE,QAAQ;QAAI;IAEtB;AACJ"}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}